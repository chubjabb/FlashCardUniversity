<!DOCTYPE html>
<html>
<head>
    <title>Anki Deck Sharing</title>
    <style>
        /* Your existing CSS styles */
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            line-height: 1.6;
        }
        .deck { 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px;
            background: #f9f9f9;
        }
        .upload-form { 
            margin: 30px 0; 
            padding: 25px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: #f0f8ff;
        }
        button { 
            background: #007cba; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }
        button:hover { background: #005a87; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .stats {
            font-size: 0.9em;
            color: #666;
        }
    </style>
    
    <!-- Load Supabase FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>üîñ Anki Deck Sharing Platform</h1>
    <p>Share and discover pre-made Anki decks with the community!</p>
    
    <!-- Upload Form -->
    <div class="upload-form">
        <h2>üì§ Upload New Anki Deck</h2>
        <form id="uploadForm">
            <input type="text" name="deckName" placeholder="Deck Name (e.g., 'Spanish Vocabulary')" required>
            <textarea name="description" placeholder="Deck Description (what topics does it cover? how many cards?)" required></textarea>
            <input type="file" name="ankiFile" accept=".apkg,.anki2" required>
            <button type="submit" id="uploadButton">Upload Deck</button>
        </form>
        <div id="uploadMessage"></div>
    </div>

    <!-- Deck List -->
    <div id="decks-container">
        <h2>üìö Available Decks</h2>
        <div id="decks-list" class="loading">Loading...</div>
    </div>

    <!-- Load your app.js AFTER Supabase -->
    <script src="app.js"></script>
<!-- Add this right before the closing </body> tag in your index.html -->
<div id="adminPanel" style="display: none; border: 2px solid #ff4444; padding: 20px; margin: 20px 0; background: #fff0f0;">
    <h3>üîß Admin Panel</h3>
    <div>
        <button onclick="deleteAllDecks()" style="background: #ff4444;">üóëÔ∏è Delete All Decks</button>
        <button onclick="exportDeckData()" style="background: #44aa44;">üìä Export Data</button>
        <button onclick="toggleAdminMode()" style="background: #666;">‚ùå Exit Admin</button>
    </div>
    <div id="adminStats" style="margin-top: 10px; font-size: 0.9em;"></div>
</div>

<script>
// Add these functions to your app.js

function updateAdminPanel() {
    const adminPanel = document.getElementById('adminPanel');
    const adminStats = document.getElementById('adminStats');
    
    if (isAdminMode()) {
        adminPanel.style.display = 'block';
        adminStats.innerHTML = `
            Total Decks: ${decks.length}<br>
            Total Downloads: ${decks.reduce((sum, deck) => sum + (deck.download_count || 0), 0)}
        `;
    } else {
        adminPanel.style.display = 'none';
    }
}

async function deleteAllDecks() {
    if (!confirm('üö® DANGER! This will delete ALL decks permanently! Are you absolutely sure?')) {
        return;
    }
    
    if (!prompt('Type "DELETE ALL" to confirm:') === 'DELETE ALL') {
        alert('Cancelled');
        return;
    }
    
    try {
        // Get all decks first
        const { data: allDecks, error: fetchError } = await supabaseClient
            .from('decks')
            .select('*');
        
        if (fetchError) throw fetchError;
        
        // Delete all files from storage
        const fileNames = allDecks.map(deck => {
            const fileUrl = deck.file_url;
            return fileUrl.split('/').pop();
        });
        
        if (fileNames.length > 0) {
            const { error: storageError } = await supabaseClient.storage
                .from('anki-decks')
                .remove(fileNames);
            
            if (storageError) console.error('Storage deletion errors:', storageError);
        }
        
        // Delete all database records
        const { error: dbError } = await supabaseClient
            .from('decks')
            .delete()
            .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all
        
        if (dbError) throw dbError;
        
        alert(`Successfully deleted ${allDecks.length} decks!`);
        loadDecks();
        
    } catch (error) {
        console.error('Delete all error:', error);
        alert('Error deleting all decks: ' + error.message);
    }
}

function exportDeckData() {
    const dataStr = JSON.stringify(decks, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `anki-decks-export-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

// Update your existing functions
function toggleAdminMode() {
    const password = prompt("Enter admin password:");
    if (password === ADMIN_PASSWORD) {
        const currentlyAdmin = isAdminMode();
        localStorage.setItem('admin-mode', !currentlyAdmin);
        alert(`Admin mode ${!currentlyAdmin ? 'enabled' : 'disabled'}`);
        loadDecks();
        updateAdminPanel();
    } else if (password) {
        alert("Incorrect password");
    }
}

// Update loadDecks to refresh admin panel
async function loadDecks() {
    // ... your existing loadDecks code ...
    
    // Add this at the end of the function, after renderDecks():
    if (isAdminMode()) {
        updateAdminPanel();
    }
}
</script>
</body>
</html>
